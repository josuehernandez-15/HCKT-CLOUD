service: alerta-utec-analitica

provider:
  name: aws
  runtime: python3.10
  region: us-east-1
  memorySize: 512
  timeout: 60
  iam:
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/LabRole
  environment:
    TABLE_INCIDENTES: ${env:TABLE_INCIDENTES}
    TABLE_LOGS: ${env:TABLE_LOGS}
    TABLE_EMPLEADOS: ${env:TABLE_EMPLEADOS}
  layers:
    - ${cf:alerta-utec-dependencias-dev.PythonDependenciesLayerExport}

functions: {}

resources:
  Resources:
    AnaliticaAirflowLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /ecs/alerta-utec-airflow
        RetentionInDays: 14

    AnaliticaAirflowCluster:
      Type: AWS::ECS::Cluster
      Properties:
        ClusterName: alerta-utec-analitica-cluster

    AnaliticaAirflowSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Acceso saliente para Airflow
        VpcId: ${env:ANALITICA_VPC_ID}
        SecurityGroupEgress:
          - IpProtocol: "-1"
            CidrIp: 0.0.0.0/0

    AnaliticaAirflowTaskDefinition:
      Type: AWS::ECS::TaskDefinition
      Properties:
        Family: alerta-utec-analitica-airflow
        Cpu: "1024"
        Memory: "2048"
        NetworkMode: awsvpc
        RequiresCompatibilities:
          - FARGATE
        ExecutionRoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/LabRole
        TaskRoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/LabRole
        ContainerDefinitions:
          - Name: airflow
            Image: apache/airflow:2.9.2-python3.10
            Essential: true
            PortMappings:
              - ContainerPort: 8080
            LogConfiguration:
              LogDriver: awslogs
              Options:
                awslogs-group: /ecs/alerta-utec-airflow
                awslogs-region: ${env:AWS_REGION, 'us-east-1'}
                awslogs-stream-prefix: airflow
            Environment:
              - Name: AWS_REGION
                Value: ${env:AWS_REGION, 'us-east-1'}
              - Name: AWS_ACCOUNT_ID
                Value: !Sub ${AWS::AccountId}
              - Name: ANALITICA_TABLES
                Value: ${env:ANALITICA_TABLES}
              - Name: ANALITICA_S3_BUCKET
                Value: ${env:ANALITICA_S3_BUCKET}
              - Name: ANALITICA_GLUE_DATABASE
                Value: ${env:ANALITICA_GLUE_DATABASE}
              - Name: ANALITICA_GLUE_CRAWLER
                Value: ${env:ANALITICA_GLUE_CRAWLER}
              - Name: ANALITICA_GLUE_ROLE_NAME
                Value: ${env:ANALITICA_GLUE_ROLE_NAME, 'GlueCrawlerRole'}
              - Name: ANALITICA_DAG_S3_URI
                Value: s3://${env:ANALITICA_S3_BUCKET}/dags/etl_dynamodb.py
              - Name: AIRFLOW_UID
                Value: "0"
              - Name: AIRFLOW__CORE__EXECUTOR
                Value: SequentialExecutor
              - Name: AIRFLOW__CORE__LOAD_EXAMPLES
                Value: "False"
              - Name: AIRFLOW__CORE__DAGS_FOLDER
                Value: /opt/airflow/dags
              - Name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
                Value: sqlite:////opt/airflow/airflow.db
            Command:
              - /bin/bash
              - -c
              - |
                set -e
                pip install --quiet awscli
                mkdir -p /opt/airflow/dags
                aws s3 cp "${ANALITICA_DAG_S3_URI}" /opt/airflow/dags/etl_dynamodb.py
                airflow db init
                exec airflow standalone

    AnaliticaAirflowService:
      Type: AWS::ECS::Service
      Properties:
        ServiceName: alerta-utec-analitica-airflow
        Cluster: !Ref AnaliticaAirflowCluster
        LaunchType: FARGATE
        DesiredCount: 1
        TaskDefinition: !Ref AnaliticaAirflowTaskDefinition
        NetworkConfiguration:
          AwsvpcConfiguration:
            AssignPublicIp: ENABLED
            Subnets:
              Fn::Split:
                - ","
                - ${env:ANALITICA_SUBNETS}
            SecurityGroups:
              - !Ref AnaliticaAirflowSecurityGroup

  Outputs:
    AnaliticaAirflowServiceName:
      Value: !Ref AnaliticaAirflowService
      Export:
        Name: alerta-utec-analitica-airflow-service

