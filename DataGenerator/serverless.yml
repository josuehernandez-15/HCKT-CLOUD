service: alerta-utec-data-generator

provider:
  name: aws
  runtime: python3.13
  region: us-east-1
  memorySize: 256
  timeout: 30
  iam:
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/LabRole
  environment:
    TABLE_USUARIOS: ${env:TABLE_USUARIOS}
    TABLE_INCIDENTES: ${env:TABLE_INCIDENTES}
    TABLE_EMPLEADOS: ${env:TABLE_EMPLEADOS}
    TABLE_LOGS: ${env:TABLE_LOGS}
    TABLE_CONEXIONES: ${env:TABLE_CONEXIONES}

functions:
  # Funci√≥n para poblar las tablas con datos de ejemplo
  poblarDatos:
    handler: handler.poblar_datos
    description: Carga datos de ejemplo desde los archivos JSON a las tablas DynamoDB
    events:
      - http:
          path: /poblar-datos
          method: post
          cors: true

resources:
  Resources:
    # ============================================================
    # TABLA: USUARIOS
    # ============================================================
    UsuariosTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${env:TABLE_USUARIOS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: usuario_id
            AttributeType: S
          - AttributeName: correo
            AttributeType: S
        KeySchema:
          - AttributeName: usuario_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: correo-index
            KeySchema:
              - AttributeName: correo
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          - Key: Proyecto
            Value: AlertaUTEC
          - Key: Entorno
            Value: dev

    # ============================================================
    # TABLA: INCIDENTES
    # ============================================================
    IncidentesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${env:TABLE_INCIDENTES}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: incidente_id
            AttributeType: S
          - AttributeName: usuario_id
            AttributeType: S
          - AttributeName: estado
            AttributeType: S
          - AttributeName: creado_en
            AttributeType: S
        KeySchema:
          - AttributeName: incidente_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: usuario_id-index
            KeySchema:
              - AttributeName: usuario_id
                KeyType: HASH
              - AttributeName: creado_en
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: estado-creado_en-index
            KeySchema:
              - AttributeName: estado
                KeyType: HASH
              - AttributeName: creado_en
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          - Key: Proyecto
            Value: AlertaUTEC
          - Key: Entorno
            Value: dev

    # ============================================================
    # TABLA: EMPLEADOS
    # ============================================================
    EmpleadosTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${env:TABLE_EMPLEADOS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: empleado_id
            AttributeType: S
          - AttributeName: tipo_area
            AttributeType: S
        KeySchema:
          - AttributeName: empleado_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: tipo_area-index
            KeySchema:
              - AttributeName: tipo_area
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Proyecto
            Value: AlertaUTEC
          - Key: Entorno
            Value: dev

    # ============================================================
    # TABLA: LOGS (REGISTROS)
    # ============================================================
    LogsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${env:TABLE_LOGS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: registro_id
            AttributeType: S
          - AttributeName: servicio
            AttributeType: S
          - AttributeName: marca_tiempo
            AttributeType: S
          - AttributeName: nivel
            AttributeType: S
        KeySchema:
          - AttributeName: registro_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: servicio-marca_tiempo-index
            KeySchema:
              - AttributeName: servicio
                KeyType: HASH
              - AttributeName: marca_tiempo
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: nivel-marca_tiempo-index
            KeySchema:
              - AttributeName: nivel
                KeyType: HASH
              - AttributeName: marca_tiempo
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: expiracion_ttl
          Enabled: true
        Tags:
          - Key: Proyecto
            Value: AlertaUTEC
          - Key: Entorno
            Value: dev

    # ============================================================
    # TABLA: CONEXIONES (WebSocket)
    # ============================================================
    ConexionesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${env:TABLE_CONEXIONES}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: conexion_id
            AttributeType: S
          - AttributeName: usuario_id
            AttributeType: S
        KeySchema:
          - AttributeName: conexion_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: usuario_id-index
            KeySchema:
              - AttributeName: usuario_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: expiracion_ttl
          Enabled: true
        Tags:
          - Key: Proyecto
            Value: AlertaUTEC
          - Key: Entorno
            Value: dev

  Outputs:
    UsuariosTableName:
      Value: !Ref UsuariosTable
      Export:
        Name: ${self:service}-UsuariosTable
    
    UsuariosTableArn:
      Value: !GetAtt UsuariosTable.Arn
      Export:
        Name: ${self:service}-UsuariosTableArn
    
    IncidentesTableName:
      Value: !Ref IncidentesTable
      Export:
        Name: ${self:service}-IncidentesTable
    
    IncidentesTableArn:
      Value: !GetAtt IncidentesTable.Arn
      Export:
        Name: ${self:service}-IncidentesTableArn
    
    EmpleadosTableName:
      Value: !Ref EmpleadosTable
      Export:
        Name: ${self:service}-EmpleadosTable
    
    EmpleadosTableArn:
      Value: !GetAtt EmpleadosTable.Arn
      Export:
        Name: ${self:service}-EmpleadosTableArn
    
    LogsTableName:
      Value: !Ref LogsTable
      Export:
        Name: ${self:service}-LogsTable
    
    LogsTableArn:
      Value: !GetAtt LogsTable.Arn
      Export:
        Name: ${self:service}-LogsTableArn
    
    ConexionesTableName:
      Value: !Ref ConexionesTable
      Export:
        Name: ${self:service}-ConexionesTable
    
    ConexionesTableArn:
      Value: !GetAtt ConexionesTable.Arn
      Export:
        Name: ${self:service}-ConexionesTableArn